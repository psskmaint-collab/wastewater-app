<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wastewater Monitoring Dashboard (Cloud Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0f4f8; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .status-pass { background-color: #dcfce7; color: #166534; }
        .status-fail { background-color: #fee2e2; color: #991b1b; }
        .gradient-header { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .ai-sparkle { color: #8b5cf6; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        #aiLoader, #syncLoader { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="gradient-header p-6 rounded-2xl text-white mb-8 shadow-lg flex justify-between items-center">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡∏ó‡∏¥‡πâ‡∏á (Cloud Sync)</h1>
                <p class="opacity-90 mt-2">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ï‡πÄ‡∏ó‡∏µ‡∏¢‡∏° | ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets</p>
            </div>
            <div class="flex gap-2">
                <button id="syncBtn" onclick="fetchFromSheet()" class="bg-blue-800 text-white px-4 py-2 rounded-xl font-bold shadow-md hover:bg-blue-900 transition flex items-center gap-2">
                    <span id="syncLoader" class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                    <span>üîÑ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                </button>
                <button onclick="generateAIReport()" class="bg-white text-blue-700 px-4 py-2 rounded-xl font-bold shadow-md hover:bg-blue-50 transition flex items-center gap-2">
                    <span>‚ú® ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° AI</span>
                </button>
            </div>
        </header>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card p-6 flex flex-col items-center justify-center border-l-4 border-blue-500">
                <span class="text-gray-500 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</span>
                <span id="totalRecords" class="text-3xl font-bold text-blue-600">0</span>
            </div>
            <div class="card p-6 flex flex-col items-center justify-center border-l-4 border-green-500">
                <span class="text-gray-500 text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</span>
                <span id="buildingStatus" class="text-xl font-semibold text-green-600">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </div>
            <div class="card p-6 flex flex-col items-center justify-center border-l-4 border-purple-500">
                <span class="text-gray-500 text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ï‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</span>
                <span id="dialysisStatus" class="text-xl font-semibold text-purple-600">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </div>
            <div class="card p-6 flex flex-col items-center justify-center border-l-4 border-yellow-500">
                <span class="text-gray-500 text-sm">‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                <span id="avgChlorine" class="text-3xl font-bold text-yellow-600">0.00</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Form Card -->
            <div class="card p-6 lg:col-span-1">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-blue-800 flex items-center gap-2">
                    üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Cloud
                </h2>
                <form id="dataForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
                        <input type="datetime-local" id="recordDateTime" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-blue-50 border" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏∞‡∏ö‡∏ö</label>
                        <select id="systemType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-gray-50 border" required>
                            <option value="building">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏Å,‡∏Ç,‡∏Ñ,‡∏á)</option>
                            <option value="dialysis">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡πÑ‡∏ï‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">TDS ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á (ppm)</label>
                            <input type="number" id="tdsIn" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-gray-50 border" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">TDS ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (ppm)</label>
                            <input type="number" id="tdsOut" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-gray-50 border" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞ (0.5 - 0.9 mg/L)</label>
                        <input type="number" step="0.1" id="chlorine" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-gray-50 border" required>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition shadow-lg">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets
                    </button>
                </form>
            </div>

        <!-- Table -->
        <div class="card overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-xl font-semibold">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets</h2>
                <div id="statusText" class="text-xs text-gray-500 italic">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-sm uppercase text-gray-600">
                            <th class="p-4 border-b">‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</th>
                            <th class="p-4 border-b">‡∏£‡∏∞‡∏ö‡∏ö</th>
                            <th class="p-4 border-b">TDS ‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å</th>
                            <th class="p-4 border-b">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</th>
                            <th class="p-4 border-b">Cl</th>
                            <th class="p-4 border-b text-center">‡∏ú‡∏•</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="text-sm text-gray-700"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- AI Modal -->
    <div id="aiModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl max-w-2xl w-full p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-blue-800">‚ú® AI ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</h3>
                <button onclick="closeAIModal()" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div id="modalContent" class="prose prose-blue text-gray-700 whitespace-pre-line"></div>
        </div>
    </div>

    <script>
        /** * [‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] 
         * ‡∏ô‡∏≥ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£ Deploy "Web App" ‡πÉ‡∏ô Google Apps Script 
         * ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ
         */
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzrsl1bWo0lfsIzPiKVDTchIUGaz9mYYxpsUrr69Qtd9vTe8fb5qXYdbqYjQ5SPI2g8Aw/exec"; 
        const apiKey = "AIzaSyCONeF3_y6r1S31ftUFEkuR8p8SDz09iw0"; 

        let logs = [];

        function setDefaultDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('recordDateTime').value = now.toISOString().slice(0, 16);
        }

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets
        async function sendToSheet(data) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

            try {
                // ‡πÉ‡∏ä‡πâ URLSearchParams ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö POST ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS ‡πÉ‡∏ô Apps Script ‡∏ö‡∏≤‡∏á‡πÅ‡∏ö‡∏ö)
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Apps Script
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î no-cors ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô response ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ 
                // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                setTimeout(fetchFromSheet, 1500);
                return true;
            } catch (e) {
                console.error("Error sending to sheet:", e);
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets";
            }
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets
        async function fetchFromSheet() {
            if (WEB_APP_URL === "‡πÉ‡∏™‡πà_URL_‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà") return;
            
            document.getElementById('syncLoader').style.display = 'block';
            try {
                const response = await fetch(`${WEB_APP_URL}?action=read`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    logs = data.map(row => ({
                        timestamp: row[0],
                        type: row[1],
                        tdsIn: row[2],
                        tdsOut: row[3],
                        diff: row[4],
                        chlorine: row[5],
                        isPass: row[6] === "‡∏ú‡πà‡∏≤‡∏ô" || row[6] === true,
                        typeKey: row[1] === "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£" ? "building" : "dialysis",
                        rawDate: new Date(row[0])
                    }));
                    
                    logs.sort((a, b) => b.rawDate - a.rawDate);
                    updateUI();
                    document.getElementById('statusText').innerText = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleTimeString('th-TH')}`;
                }
            } catch (e) {
                console.error("Error fetching data:", e);
            } finally {
                document.getElementById('syncLoader').style.display = 'none';
            }
        }

        async function callGemini(prompt) {
            if (!apiKey) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI";
            document.getElementById('aiLoader').style.display = 'block';
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢ ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÑ‡∏î‡πâ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢" }] }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) { return "AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"; }
            finally { document.getElementById('aiLoader').style.display = 'none'; }
        }

        document.getElementById('dataForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const dateVal = document.getElementById('recordDateTime').value;
            const type = document.getElementById('systemType').value;
            const tdsIn = parseFloat(document.getElementById('tdsIn').value);
            const tdsOut = parseFloat(document.getElementById('tdsOut').value);
            const chlorine = parseFloat(document.getElementById('chlorine').value);
            const diff = tdsOut - tdsIn;

            let isPass = false;
            if (type === 'building') {
                isPass = diff <= 500 && (chlorine >= 0.5 && chlorine <= 0.9);
            } else {
                isPass = tdsOut <= 1000 && (chlorine >= 0.5 && chlorine <= 0.9);
            }

            const dataToSave = {
                timestamp: new Date(dateVal).toLocaleString('th-TH'),
                type: type === 'building' ? '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£' : '‡πÑ‡∏ï‡πÄ‡∏ó‡∏µ‡∏¢‡∏°',
                tdsIn, tdsOut, diff, chlorine,
                result: isPass ? "‡∏ú‡πà‡∏≤‡∏ô" : "‡∏ï‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå"
            };

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Cloud
            await sendToSheet(dataToSave);
            
            // AI Analysis
            const aiPrompt = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö ${dataToSave.type}: TDS In ${tdsIn}, Out ${tdsOut} (Diff ${diff}), Cl ${chlorine}. ‡∏ú‡∏•‡∏Ñ‡∏∑‡∏≠ ${dataToSave.result}. ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ`;
            document.getElementById('aiContent').innerText = await callGemini(aiPrompt);
            
            this.reset();
            setDefaultDateTime();
        });

        function updateUI() {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = logs.map(log => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-4">${log.timestamp}</td>
                    <td class="p-4 text-xs font-bold ${log.typeKey === 'building' ? 'text-blue-600' : 'text-purple-600'}">${log.type}</td>
                    <td class="p-4">${log.tdsIn}/${log.tdsOut}</td>
                    <td class="p-4 font-bold ${log.diff > 500 && log.typeKey === 'building' ? 'text-red-600' : ''}">${log.diff}</td>
                    <td class="p-4">${log.chlorine}</td>
                    <td class="p-4 text-center">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold ${log.isPass ? 'status-pass' : 'status-fail'}">${log.isPass ? '‡∏ú‡πà‡∏≤‡∏ô' : '‡∏ï‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå'}</span>
                    </td>
                </tr>
            `).join('');

            document.getElementById('totalRecords').innerText = logs.length;
            if (logs.length > 0) {
                const lastB = logs.find(l => l.typeKey === 'building');
                if (lastB) {
                    document.getElementById('buildingStatus').innerText = lastB.isPass ? '‡∏õ‡∏Å‡∏ï‡∏¥' : '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
                    document.getElementById('buildingStatus').className = `text-xl font-semibold ${lastB.isPass ? 'text-green-600' : 'text-red-600'}`;
                }
                const lastD = logs.find(l => l.typeKey === 'dialysis');
                if (lastD) {
                    document.getElementById('dialysisStatus').innerText = lastD.isPass ? '‡∏õ‡∏Å‡∏ï‡∏¥' : '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
                    document.getElementById('dialysisStatus').className = `text-xl font-semibold ${lastD.isPass ? 'text-green-600' : 'text-red-600'}`;
                }
                document.getElementById('avgChlorine').innerText = logs[0].chlorine.toFixed(2);
            }
        }

        async function generateAIReport() {
            if (logs.length === 0) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            document.getElementById('aiModal').style.display = 'flex';
            const context = logs.slice(0, 5).map(l => `${l.timestamp}: ${l.type} Result ${l.isPass}`).join('\n');
            document.getElementById('modalContent').innerText = await callGemini("‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets:\n" + context);
        }

        function closeAIModal() { document.getElementById('aiModal').style.display = 'none'; }

        window.onload = () => {
            setDefaultDateTime();
            if (WEB_APP_URL !== "‡πÉ‡∏™‡πà_URL_‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà") fetchFromSheet();
        };
    </script>
</body>
</html>