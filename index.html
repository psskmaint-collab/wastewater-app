<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wastewater Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .status-pass { background-color: #dcfce7; color: #166534; }
        .status-fail { background-color: #fee2e2; color: #991b1b; }
        .gradient-header { background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%); }
        #syncLoader { display: none; }
        .chart-container { position: relative; height: 220px; width: 100%; }
        .kpi-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 2px; }
        .value-display { font-size: 1.1rem; font-weight: 700; }
        .badge-status { font-size: 0.65rem; padding: 2px 8px; border-radius: 9999px; font-weight: 600; }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-800">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="gradient-header p-6 rounded-2xl text-white mb-8 shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ô‡πâ‡∏≥‡∏ó‡∏¥‡πâ‡∏á</h1>
                <p class="opacity-90 mt-1">‡πÄ‡∏Å‡∏ì‡∏ë‡πå: ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (Diff ‚â§ 500) | ‡πÑ‡∏ï‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Diff ‚â§ 1,000) | ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ô (0.5-0.9)</p>
            </div>
            <button id="syncBtn" onclick="fetchFromSheet()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-md hover:bg-blue-700 transition flex items-center gap-2">
                <span id="syncLoader" class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                <span>üîÑ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
            </button>
        </header>

        <!-- KPI Cards (Updated Layout) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Building System KPI -->
            <div class="card p-5 border-l-8 border-blue-500 flex flex-col justify-between">
                <h3 class="font-bold text-blue-800 mb-3 border-b pb-2">üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="kpi-label">‡∏Ñ‡πà‡∏≤ TDS Diff</p>
                        <p id="bTdsVal" class="value-display text-slate-700">-</p>
                        <span id="bTdsStatus" class="badge-status bg-gray-100 text-gray-500">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                    </div>
                    <div>
                        <p class="kpi-label">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ô</p>
                        <p id="bClVal" class="value-display text-slate-700">-</p>
                        <span id="bClStatus" class="badge-status bg-gray-100 text-gray-500">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                    </div>
                </div>
            </div>

            <!-- Dialysis System KPI -->
            <div class="card p-5 border-l-8 border-purple-500 flex flex-col justify-between">
                <h3 class="font-bold text-purple-800 mb-3 border-b pb-2">üíâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡πÑ‡∏ï‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="kpi-label">‡∏Ñ‡πà‡∏≤ TDS Diff</p>
                        <p id="dTdsVal" class="value-display text-slate-700">-</p>
                        <span id="dTdsStatus" class="badge-status bg-gray-100 text-gray-500">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                    </div>
                    <div>
                        <p class="kpi-label">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ô</p>
                        <p id="dClVal" class="value-display text-slate-700">-</p>
                        <span id="dClStatus" class="badge-status bg-gray-100 text-gray-500">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                    </div>
                </div>
            </div>

            <!-- Summary KPI -->
            <div class="card p-5 border-l-8 border-emerald-500 flex items-center justify-around bg-emerald-50/30">
                <div class="text-center">
                    <p class="kpi-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <p id="totalRecords" class="text-3xl font-black text-emerald-600">0</p>
                </div>
                <div class="text-center">
                    <p class="kpi-label">‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
                    <p id="lastCheckTime" class="text-sm font-bold text-slate-500">-</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Form Card -->
            <div class="card p-6 lg:col-span-1">
                <h2 class="text-xl font-semibold mb-5 text-blue-800 flex items-center gap-2">
                    üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                </h2>
                <form id="dataForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <input type="datetime-local" id="recordDateTime" class="mt-1 block w-full border-gray-300 rounded-lg p-2 bg-slate-50 border focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏∞‡∏ö‡∏ö</label>
                        <select id="systemType" class="mt-1 block w-full border-gray-300 rounded-lg p-2 bg-slate-50 border focus:ring-2 focus:ring-blue-500 outline-none" required>
                            <option value="building">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (Diff ‚â§ 500)</option>
                            <option value="dialysis">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡πÑ‡∏ï‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Diff ‚â§ 1,000)</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">TDS ‡πÄ‡∏Ç‡πâ‡∏≤ (ppm)</label>
                            <input type="number" id="tdsIn" class="mt-1 block w-full border-gray-300 rounded-lg p-2 bg-slate-50 border focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">TDS ‡∏≠‡∏≠‡∏Å (ppm)</label>
                            <input type="number" id="tdsOut" class="mt-1 block w-full border-gray-300 rounded-lg p-2 bg-slate-50 border focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞ (0.5 - 0.9 mg/L)</label>
                        <input type="number" step="0.1" id="chlorine" class="mt-1 block w-full border-gray-300 rounded-lg p-2 bg-slate-50 border focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg mt-2">
                        ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Cloud
                    </button>
                </form>
            </div>

            <!-- Charts Container -->
            <div class="lg:col-span-2 space-y-6">
                <div class="card p-6 border-t-4 border-blue-500">
                    <h3 class="text-lg font-semibold mb-4 text-slate-700 flex items-center justify-between">
                        <span>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á TDS (10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</span>
                    </h3>
                    <div class="chart-container">
                        <canvas id="tdsDiffChart"></canvas>
                    </div>
                </div>
                <div class="card p-6 border-t-4 border-yellow-500">
                    <h3 class="text-lg font-semibold mb-4 text-slate-700 flex items-center justify-between">
                        <span>üíß ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞ (10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</span>
                    </h3>
                    <div class="chart-container">
                        <canvas id="clChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Table -->
        <div class="card overflow-hidden">
            <div class="p-6 border-b flex flex-col md:flex-row justify-between items-center bg-gray-50 gap-2">
                <h2 class="text-xl font-semibold text-slate-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                <div id="statusText" class="text-sm text-slate-500 italic text-right">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-100 text-xs uppercase text-slate-600 tracking-wider">
                            <th class="p-4 border-b">‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th class="p-4 border-b">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th class="p-4 border-b">TDS (‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å)</th>
                            <th class="p-4 border-b">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (Diff)</th>
                            <th class="p-4 border-b text-center">‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ô</th>
                            <th class="p-4 border-b text-center">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="text-sm text-slate-700"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzrsl1bWo0lfsIzPiKVDTchIUGaz9mYYxpsUrr69Qtd9vTe8fb5qXYdbqYjQ5SPI2g8Aw/exec"; 
        
        let logs = [];
        let tdsDiffChart = null;
        let clChart = null;

        function initializeApp() {
            setDefaultDateTime();
            fetchFromSheet();
            setInterval(fetchFromSheet, 300000);
        }

        function setDefaultDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('recordDateTime').value = now.toISOString().slice(0, 16);
        }

        function parseSheetDate(dateStr) {
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) return date;
                const parts = dateStr.match(/(\d+)/g);
                if (parts && parts.length >= 3) {
                    return new Date(parts[2], parts[1]-1, parts[0], parts[3]||0, parts[4]||0);
                }
                return new Date();
            } catch (e) { return new Date(); }
        }

        function formatDisplayDate(date) {
            return date.toLocaleString('th-TH', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false
            });
        }

        function updateCharts() {
            const chartData = [...logs].slice(0, 10).reverse();
            const labels = chartData.map(d => d.timestamp.split(' ')[1]); 
            
            const tdsCtx = document.getElementById('tdsDiffChart').getContext('2d');
            if (tdsDiffChart) tdsDiffChart.destroy();
            tdsDiffChart = new Chart(tdsCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á TDS (ppm)',
                        data: chartData.map(d => d.diff),
                        backgroundColor: chartData.map(d => d.diffPass ? '#3b82f6' : '#ef4444'),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            const clCtx = document.getElementById('clChart').getContext('2d');
            if (clChart) clChart.destroy();
            clChart = new Chart(clCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞',
                        data: chartData.map(d => d.chlorine),
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: chartData.map(d => d.chlorinePass ? '#fbbf24' : '#ef4444')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { min: 0, max: 1.5 } }
                }
            });
        }

        async function fetchFromSheet() {
            const loader = document.getElementById('syncLoader');
            loader.style.display = 'block';
            try {
                const response = await fetch(`${WEB_APP_URL}?action=read`);
                const data = await response.json();
                if (data && Array.isArray(data)) {
                    logs = data.map(row => {
                        const dateObj = parseSheetDate(row[0]);
                        const type = row[1];
                        const tdsIn = parseFloat(row[2]) || 0;
                        const tdsOut = parseFloat(row[3]) || 0;
                        const diff = parseFloat(row[4]) || 0;
                        const chlorine = parseFloat(row[5]) || 0;
                        const isBuilding = type === "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£";
                        const diffLimit = isBuilding ? 500 : 1000;
                        const diffPass = (diff <= diffLimit && diff >= 0);
                        const chlorinePass = (chlorine >= 0.5 && chlorine <= 0.9);

                        return {
                            timestamp: formatDisplayDate(dateObj),
                            type: type,
                            tdsIn: tdsIn,
                            tdsOut: tdsOut,
                            diff: diff,
                            chlorine: chlorine,
                            diffPass: diffPass,
                            chlorinePass: chlorinePass,
                            isPass: diffPass && chlorinePass,
                            typeKey: isBuilding ? "building" : "dialysis",
                            rawDate: dateObj
                        };
                    });
                    logs.sort((a, b) => b.rawDate - a.rawDate);
                    updateUI();
                    updateCharts();
                }
            } catch (e) { console.error(e); }
            finally { loader.style.display = 'none'; }
        }

        async function sendToSheet(payload) {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                setTimeout(fetchFromSheet, 2000);
            } catch (e) { alert("Error"); }
            finally { 
                btn.disabled = false;
                btn.innerText = "‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Cloud";
            }
        }

        document.getElementById('dataForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const dateInput = document.getElementById('recordDateTime').value;
            const sysType = document.getElementById('systemType').value;
            const tdsInValue = parseFloat(document.getElementById('tdsIn').value);
            const tdsOutValue = parseFloat(document.getElementById('tdsOut').value);
            const clValue = parseFloat(document.getElementById('chlorine').value);
            
            const diffValue = tdsOutValue - tdsInValue;
            const diffLimit = (sysType === 'building') ? 500 : 1000;
            const isOk = (diffValue <= diffLimit && diffValue >= 0) && (clValue >= 0.5 && clValue <= 0.9);

            await sendToSheet({
                timestamp: new Date(dateInput).toISOString(),
                type: sysType === 'building' ? '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£' : '‡πÑ‡∏ï‡πÄ‡∏ó‡∏µ‡∏¢‡∏°',
                tdsIn: tdsInValue,
                tdsOut: tdsOutValue,
                diff: diffValue,
                chlorine: clValue,
                result: isOk ? "‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå" : "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå"
            });
            this.reset();
            setDefaultDateTime();
        });

        function updateKPI(prefix, log) {
            const tdsVal = document.getElementById(prefix + 'TdsVal');
            const tdsStat = document.getElementById(prefix + 'TdsStatus');
            const clVal = document.getElementById(prefix + 'ClVal');
            const clStat = document.getElementById(prefix + 'ClStatus');

            if (log) {
                tdsVal.innerText = log.diff + ' ppm';
                tdsStat.innerText = log.diffPass ? '‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå';
                tdsStat.className = `badge-status ${log.diffPass ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
                
                clVal.innerText = log.chlorine + ' mg/L';
                clStat.innerText = log.chlorinePass ? '‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå';
                clStat.className = `badge-status ${log.chlorinePass ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            }
        }

        function updateUI() {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = logs.map(log => `
                <tr class="hover:bg-slate-50 border-b transition-colors">
                    <td class="p-4 text-xs font-medium text-slate-500">${log.timestamp}</td>
                    <td class="p-4">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold ${log.typeKey === 'building' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">
                            ${log.type}
                        </span>
                    </td>
                    <td class="p-4 text-xs font-mono">${log.tdsIn} / ${log.tdsOut}</td>
                    <td class="p-4 text-xs font-bold ${log.diffPass ? 'text-slate-700' : 'text-red-600'}">${log.diff}</td>
                    <td class="p-4 text-center">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold ${log.chlorinePass ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}">
                            ${log.chlorine}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase ${log.isPass ? 'status-pass' : 'status-fail'}">
                            ${log.isPass ? '‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå'}
                        </span>
                    </td>
                </tr>
            `).join('');

            document.getElementById('totalRecords').innerText = logs.length;
            if (logs.length > 0) {
                document.getElementById('lastCheckTime').innerText = logs[0].timestamp;
                updateKPI('b', logs.find(l => l.typeKey === 'building'));
                updateKPI('d', logs.find(l => l.typeKey === 'dialysis'));
            }
        }

        window.onload = initializeApp;
    </script>
</body>
</html>